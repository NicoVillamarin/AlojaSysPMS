<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlojaSys - Mapa de M贸dulos</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        #header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            position: relative;
        }

        #header h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 5px;
        }

        #header p {
            color: #666;
            font-size: 0.9em;
        }

        #mynetwork {
            width: 100%;
            height: calc(100vh - 120px);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }

        .controls {
            position: absolute;
            top: 140px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 200px;
        }

        .controls h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .controls button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
        }

        .controls button:hover {
            background: #764ba2;
        }

        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 300px;
            display: none;
        }

        .info-panel h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .info-panel p {
            color: #666;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .info-panel ul {
            color: #666;
            font-size: 0.85em;
            margin-left: 20px;
            margin-top: 10px;
        }

        .info-panel li {
            margin: 5px 0;
        }

        .info-panel h4 {
            color: #333;
            margin-top: 10px;
            font-size: 0.95em;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1> AlojaSys - Sistema de Gesti贸n Hotelera</h1>
        <p>Mapa Visual de M贸dulos y Funcionalidades</p>
    </div>

    <div class="controls">
        <h3>Controles</h3>
        <button onclick="fitNetwork()">Ajustar Vista</button>
        <button onclick="resetView()">Restablecer</button>
        <button onclick="togglePhysics()">Alternar F铆sica</button>
        <button onclick="setLayout('hierarchical')">Vista Jer谩rquica</button>
        <button onclick="setLayout('radial')">Vista Radial</button>
        <button onclick="togglePaymentSubs()">Subm贸dulos de Pagos</button>
        <button onclick="expandAll()">Expandir Todo</button>
        <button onclick="collapseAll()">Colapsar Todo</button>
    </div>

    <div class="info-panel" id="infoPanel">
        <h3 id="infoTitle"></h3>
        <p id="infoDescription"></p>
        <ul id="infoFeatures"></ul>
        <h4 id="reqTitle" style="display:none;">Requisitos</h4>
        <ul id="infoRequirements"></ul>
        <h4 id="stepsTitle" style="display:none;">Pasos de uso</h4>
        <ul id="infoSteps"></ul>
    </div>

    <div id="mynetwork"></div>

    <script type="text/javascript">
        let nodes, edges, network, physicsEnabled = true;
        const expandedModules = new Set();
        let layoutMode = 'radial';
        let showPaymentSubmodules = true;

        // Datos de los m贸dulos
        const modulesData = {
            // Nodo central
            'alojaSys': {
                label: 'AlojaSys\nSistema PMS',
                title: 'Sistema de Gesti贸n Hotelera Completo',
                description: 'Plataforma integral para administrar hoteles, reservas, pagos y m谩s.',
                group: 'center',
                level: 0
            },
            
            // M贸dulos principales
            'hoteles': {
                label: 'Gesti贸n de\nHoteles',
                title: 'Configuraci贸n y administraci贸n de hoteles',
                description: 'Gestiona informaci贸n b谩sica, horarios, automatizaciones y configuraciones de cada hotel.',
                features: [
                    'Datos del hotel (nombre, direcci贸n, contacto)',
                    'Informaci贸n legal (raz贸n social, CUIT/CUIL)',
                    'Horarios de check-in/check-out',
                    'Auto check-in/check-out configurable',
                    'Auto no-show para reservas vencidas',
                    'Zona horaria por hotel',
                    'Soporte multi-hotel'
                ],
                requirements: [
                    'Datos b谩sicos del hotel',
                    'CUIT/CUIL y raz贸n social',
                    'Ubicaci贸n (pa铆s, provincia, ciudad)',
                    'Horarios de check-in/check-out'
                ],
                steps: [
                    'Crear la empresa (opcional multi-hotel)',
                    'Crear el hotel y completar datos legales y de contacto',
                    'Configurar horarios y zona horaria',
                    'Definir automatizaciones (auto check-out/no-show)'
                ],
                group: 'config',
                level: 1
            },
            
            'habitaciones': {
                label: 'Gesti贸n de\nHabitaciones',
                title: 'Administraci贸n de habitaciones',
                description: 'Control completo de tipos, precios, capacidad y estados de habitaciones.',
                features: [
                    'Tipos de habitaci贸n (Single, Doble, Triple, Suite)',
                    'Capacidad incluida y m谩xima',
                    'Precio base y extra por hu茅sped',
                    'Estados en tiempo real',
                    'Gesti贸n por piso y n煤mero',
                    'Descripci贸n y caracter铆sticas'
                ],
                requirements: [
                    'Hotel creado',
                    'Tipos y capacidades definidas',
                    'Precios base por tipo'
                ],
                steps: [
                    'Definir tipos de habitaci贸n y capacidades',
                    'Crear habitaciones (piso, n煤mero, descripci贸n)',
                    'Establecer precio base y extra por hu茅sped',
                    'Configurar estados iniciales'
                ],
                group: 'config',
                level: 1
            },
            
            'reservas': {
                label: 'Gesti贸n de\nReservas',
                title: 'Ciclo completo de reservas',
                description: 'Desde la consulta hasta el check-out, con validaciones autom谩ticas.',
                features: [
                    'Consulta de disponibilidad',
                    'Creaci贸n y confirmaci贸n de reservas',
                    'Estados: Pendiente, Confirmada, Check-in, Check-out, Cancelada, No-show',
                    'Validaci贸n de solapamientos',
                    'Verificaci贸n con OTAs (anti-overbooking)',
                    'Restricciones CTA/CTD',
                    'Validaci贸n de estad铆a m铆nima/m谩xima'
                ],
                requirements: [
                    'Hoteles y habitaciones cargadas',
                    'Planes de tarifas activos',
                    'Pol铆ticas de pago definidas (opcional)'
                ],
                steps: [
                    'Buscar disponibilidad por fechas y capacidad',
                    'Seleccionar habitaci贸n y plan de tarifa',
                    'Cargar datos del hu茅sped y confirmar',
                    'Gestionar estados (check-in/out, cancelaciones)'
                ],
                group: 'core',
                level: 1
            },
            
            'pagos': {
                label: 'Sistema de\nPagos',
                title: 'Procesamiento de pagos',
                description: 'M煤ltiples m茅todos de pago con pol铆ticas configurables y validaciones inteligentes.',
                features: [
                    'Integraci贸n con Mercado Pago',
                    'M煤ltiples m茅todos: Tarjeta, Efectivo, Transferencia, POS',
                    'Pol铆ticas de pago configurables',
                    'Se帽as y pagos parciales',
                    'Validaciones de seguridad',
                    'Rotaci贸n segura de tokens',
                    'Webhooks y confirmaci贸n autom谩tica'
                ],
                requirements: [
                    'Configurar credenciales de pasarela por hotel',
                    'Definir pol铆ticas de pago y se帽a',
                    'Habilitar m茅todos permitidos'
                ],
                steps: [
                    'Cargar claves de Mercado Pago (test/producci贸n)',
                    'Definir pol铆ticas (porcentaje/monto y vencimientos)',
                    'Cobrar se帽a y registrar saldo al check-in/out',
                    'Usar m贸dulo de Cobros y/o Conciliaci贸n'
                ],
                group: 'payment',
                level: 1
            },
            
            'politicasCancelacion': {
                label: 'Pol铆ticas de\nCancelaci贸n',
                title: 'Reglas de cancelaci贸n',
                description: 'Pol铆ticas configurables para manejar cancelaciones con reembolsos autom谩ticos.',
                features: [
                    'Pol铆ticas por porcentaje o monto fijo',
                    'Rangos de fechas configurables',
                    'Reembolsos autom谩ticos',
                    'Diferentes pol铆ticas por canal',
                    'Aplicaci贸n por tipo de habitaci贸n',
                    'Prioridad y combinabilidad'
                ],
                group: 'policy',
                level: 1
            },
            
            'politicasDevolucion': {
                label: 'Pol铆ticas de\nDevoluci贸n',
                title: 'Reglas de devoluci贸n',
                description: 'Gesti贸n de devoluciones con pol铆ticas flexibles y procesamiento autom谩tico.',
                features: [
                    'Pol铆ticas configurables',
                    'Procesamiento autom谩tico 24/7',
                    'Validaci贸n de elegibilidad',
                    'C谩lculo autom谩tico de montos',
                    'Integraci贸n con pasarelas de pago',
                    'Notificaciones autom谩ticas'
                ],
                group: 'policy',
                level: 1
            },
            
            'tarifas': {
                label: 'Gesti贸n de\nTarifas',
                title: 'Sistema de tarifas din谩micas',
                description: 'Planes de tarifas, reglas autom谩ticas, promociones e impuestos.',
                features: [
                    'Planes de tarifas base',
                    'Reglas autom谩ticas (fin de semana, estad铆a m铆nima)',
                    'Promociones con c贸digos',
                    'Sistema de impuestos',
                    'Prioridad y alcance configurable',
                    'Aplicaci贸n por canal y tipo de habitaci贸n'
                ],
                requirements: [
                    'Tipos de habitaci贸n y precios base',
                    'Reglas de negocio (m铆n/max estad铆a, CTA/CTD)'
                ],
                steps: [
                    'Crear planes de tarifa base',
                    'Configurar reglas autom谩ticas y restricciones',
                    'Crear promociones y cupones',
                    'Definir impuestos aplicables'
                ],
                group: 'pricing',
                level: 1
            },
            
            'dashboard': {
                label: 'Dashboard y\nReportes',
                title: 'An谩lisis y m茅tricas',
                description: 'Visualizaci贸n de datos, reportes y m茅tricas del negocio.',
                features: [
                    'M茅tricas en tiempo real',
                    'Reportes personalizables',
                    'An谩lisis de ocupaci贸n',
                    'Estad铆sticas de ingresos',
                    'Gr谩ficos y visualizaciones',
                    'Exportaci贸n de datos'
                ],
                group: 'analytics',
                level: 1
            },
            
            'calendario': {
                label: 'Calendario de\nReservas',
                title: 'Vista de calendario',
                description: 'Visualizaci贸n interactiva de reservas en formato calendario.',
                features: [
                    'Vista mensual y semanal',
                    'Filtros por hotel y habitaci贸n',
                    'Drag & drop para cambios',
                    'Informaci贸n detallada de reservas',
                    'Colores por estado',
                    'B煤squeda y filtrado'
                ],
                group: 'view',
                level: 1
            },
            
            'usuarios': {
                label: 'Gesti贸n de\nUsuarios',
                title: 'Usuarios y permisos',
                description: 'Administraci贸n de usuarios, roles y permisos del sistema.',
                features: [
                    'Creaci贸n y gesti贸n de usuarios',
                    'Sistema de roles y permisos',
                    'Asignaci贸n de hoteles',
                    'Control de acceso',
                    'Imagen de perfil',
                    'Informaci贸n de contacto'
                ],
                requirements: [
                    'Definir roles (admin, recepci贸n, etc.)'
                ],
                steps: [
                    'Crear roles y permisos',
                    'Crear usuarios y asignar roles',
                    'Asignar hoteles a cada usuario'
                ],
                group: 'config',
                level: 1
            },
            
            'empresas': {
                label: 'Gesti贸n de\nEmpresas',
                title: 'Administraci贸n de empresas',
                description: 'Gesti贸n de empresas que operan m煤ltiples hoteles.',
                features: [
                    'Datos de empresa',
                    'Informaci贸n legal (CUIT/CUIL)',
                    'Ubicaci贸n (Pa铆s, Provincia, Ciudad)',
                    'Contacto y direcci贸n',
                    'Relaci贸n con hoteles'
                ],
                requirements: [
                    'Datos legales y de contacto de la empresa'
                ],
                steps: [
                    'Crear empresa',
                    'Asociar hoteles existentes o crear nuevos'
                ],
                group: 'config',
                level: 1
            },
            
            'notificaciones': {
                label: 'Sistema de\nNotificaciones',
                title: 'Notificaciones autom谩ticas',
                description: 'Sistema de alertas y notificaciones para eventos importantes.',
                features: [
                    'Notificaciones en tiempo real',
                    'M煤ltiples canales (email, push)',
                    'Eventos configurables',
                    'Historial de notificaciones',
                    'Preferencias de usuario'
                ],
                group: 'system',
                level: 1
            },
            
            'reembolsos': {
                label: 'Procesamiento\nAutom谩tico de\nReembolsos',
                title: 'Reembolsos autom谩ticos',
                description: 'Procesamiento autom谩tico 24/7 de reembolsos seg煤n pol铆ticas.',
                features: [
                    'Procesamiento autom谩tico',
                    'Validaci贸n de elegibilidad',
                    'Integraci贸n con pasarelas',
                    'Notificaciones autom谩ticas',
                    'Logs de auditor铆a',
                    'Manejo de errores'
                ],
                group: 'automation',
                level: 1
            },
            
            'facturacion': {
                label: 'Facturaci贸n\nElectr贸nica\nArgentina',
                title: 'Facturaci贸n AFIP',
                description: 'Integraci贸n completa con AFIP para facturaci贸n electr贸nica.',
                features: [
                    'Integraci贸n con AFIP',
                    'Generaci贸n de CAE',
                    'Facturas A, B, C',
                    'Notas de cr茅dito',
                    'C贸digos QR',
                    'PDFs fiscales'
                ],
                requirements: [
                    'Datos fiscales (puntos de venta, tipo de contribuyente)',
                    'Conexi贸n con AFIP'
                ],
                steps: [
                    'Configurar datos fiscales por hotel/empresa',
                    'Emitir comprobantes desde reservas o cobros',
                    'Descargar/reenviar comprobantes'
                ],
                group: 'billing',
                level: 1
            },
            
            'comprobantes': {
                label: 'Comprobantes de\nSe帽as y\nDevoluciones',
                title: 'Comprobantes autom谩ticos',
                description: 'Generaci贸n autom谩tica de recibos y comprobantes.',
                features: [
                    'Recibos de se帽as',
                    'Comprobantes de pagos parciales',
                    'PDFs autom谩ticos',
                    'Env铆o por email',
                    'Integraci贸n con facturaci贸n'
                ],
                group: 'billing',
                level: 1
            },
            
            'otas': {
                label: 'Integraciones\ncon OTAs\n(Channel Manager)',
                title: 'Channel Manager',
                description: 'Integraci贸n con Booking.com, Airbnb y otras OTAs.',
                features: [
                    'Sincronizaci贸n bidireccional',
                    'Prevenci贸n de overbooking',
                    'Actualizaci贸n autom谩tica de disponibilidad',
                    'Sincronizaci贸n de tarifas',
                    'Gesti贸n de reservas OTA'
                ],
                requirements: [
                    'Credenciales de cada canal (Booking, Airbnb, etc.)'
                ],
                steps: [
                    'Conectar canales con credenciales',
                    'Activar sincronizaci贸n de disponibilidad y tarifas',
                    'Revisar reservas entrantes y reconciliar'
                ],
                group: 'integration',
                level: 1
            }
        };

        // Subnodos por m贸dulo (para expandir/colapsar en el grafo)
        const moduleDetails = {
            'hoteles': [
                { id: 'hoteles:datos', label: 'Datos B谩sicos' },
                { id: 'hoteles:ubicacion', label: 'Ubicaci贸n' },
                { id: 'hoteles:legales', label: 'Legales' },
                { id: 'hoteles:horarios', label: 'Horarios' },
                { id: 'hoteles:auto', label: 'Automatizaciones' }
            ],
            'habitaciones': [
                { id: 'habitaciones:tipos', label: 'Tipos' },
                { id: 'habitaciones:capacidad', label: 'Capacidad' },
                { id: 'habitaciones:precio', label: 'Precios' },
                { id: 'habitaciones:estado', label: 'Estados' },
                { id: 'habitaciones:ident', label: 'Identificaci贸n' }
            ],
            'tarifas': [
                { id: 'tarifas:planes', label: 'Planes' },
                { id: 'tarifas:reglas', label: 'Reglas' },
                { id: 'tarifas:promos', label: 'Promociones' },
                { id: 'tarifas:impuestos', label: 'Impuestos' }
            ],
            'reservas': [
                { id: 'reservas:disp', label: 'Disponibilidad' },
                { id: 'reservas:creacion', label: 'Creaci贸n' },
                { id: 'reservas:estados', label: 'Estados' },
                { id: 'reservas:valid', label: 'Validaciones' }
            ],
            'pagos': [
                { id: 'pagos:pasarelas', label: 'Pasarelas' },
                { id: 'pagos:politicas', label: 'Pol铆ticas' },
                { id: 'pagos:senas', label: 'Se帽as/Parciales' },
                { id: 'pagos:webhooks', label: 'Webhooks' }
            ],
            'usuarios': [
                { id: 'usuarios:roles', label: 'Roles' },
                { id: 'usuarios:permisos', label: 'Permisos' },
                { id: 'usuarios:asign', label: 'Asignaci贸n Hoteles' }
            ],
            'empresas': [
                { id: 'empresas:datos', label: 'Datos' },
                { id: 'empresas:hoteles', label: 'Hoteles Asociados' }
            ],
            'facturacion': [
                { id: 'facturacion:tipos', label: 'Tipos' },
                { id: 'facturacion:cae', label: 'CAE/QR' },
                { id: 'facturacion:pdf', label: 'PDFs' }
            ],
            'otas': [
                { id: 'otas:sync', label: 'Sincronizaci贸n' },
                { id: 'otas:over', label: 'Anti-Overbooking' }
            ],
            'notificaciones': [
                { id: 'notif:eventos', label: 'Eventos' },
                { id: 'notif:canales', label: 'Canales' }
            ],
            'calendario': [
                { id: 'calendario:vistas', label: 'Vistas' },
                { id: 'calendario:filtros', label: 'Filtros' }
            ]
        };

        // Sub-m贸dulos de Pagos
        const paymentSubmodules = {
            'transferencias': {
                label: 'Transferencias\nBancarias\ncon OCR',
                title: 'Transferencias con OCR',
                description: 'Procesamiento de transferencias bancarias con reconocimiento 贸ptico de comprobantes.',
                features: [
                    'Subida de comprobantes',
                    'Procesamiento OCR',
                    'Confirmaci贸n autom谩tica',
                    'Almacenamiento en nube',
                    'Validaci贸n inteligente'
                ],
                group: 'payment',
                level: 2
            },
            
            'cobros': {
                label: 'M贸dulo de\nCobros',
                title: 'Historial de cobros',
                description: 'Vista unificada de todos los pagos y cobros con an谩lisis avanzado.',
                features: [
                    'Historial completo',
                    'Filtros avanzados',
                    'Estad铆sticas y m茅tricas',
                    'Exportaci贸n CSV',
                    'Archivos adjuntos'
                ],
                group: 'payment',
                level: 2
            },
            
            'conciliacion': {
                label: 'Conciliaci贸n\nBancaria\nAutom谩tica',
                title: 'Conciliaci贸n bancaria',
                description: 'Matching autom谩tico de pagos con extractos bancarios.',
                features: [
                    'Subida de extractos CSV',
                    'Matching inteligente',
                    'Confirmaci贸n autom谩tica',
                    'Logs de auditor铆a',
                    'Configuraci贸n flexible'
                ],
                group: 'payment',
                level: 2
            },
            
            'vouchers': {
                label: 'Sistema de\nVouchers de\nCr茅dito',
                title: 'Vouchers reutilizables',
                description: 'Sistema de vouchers de cr茅dito para pagos futuros.',
                features: [
                    'Creaci贸n de vouchers',
                    'Aplicaci贸n a reservas',
                    'Seguimiento de uso',
                    'Vencimientos',
                    'Historial completo'
                ],
                group: 'payment',
                level: 2
            }
        };

        // Crear nodos y edges
        function createNetworkData() {
            nodes = new vis.DataSet([]);
            edges = new vis.DataSet([]);

            // Nodo central
            nodes.add({
                id: 'alojaSys',
                label: modulesData.alojaSys.label,
                title: modulesData.alojaSys.title,
                shape: 'box',
                color: {
                    background: '#667eea',
                    border: '#764ba2',
                    highlight: { background: '#764ba2', border: '#667eea' }
                },
                font: { color: '#ffffff', size: 24, face: 'Arial', bold: true },
                size: 50,
                level: 0
            });

            // Agregar m贸dulos principales
            Object.keys(modulesData).forEach((key, index) => {
                if (key === 'alojaSys') return;
                
                const module = modulesData[key];
                const baseNode = {
                    id: key,
                    label: module.label,
                    title: module.title,
                    shape: 'box',
                    color: getColorForGroup(module.group),
                    font: { color: '#ffffff', size: 16, face: 'Arial', bold: true },
                    size: 30
                };

                if (layoutMode === 'radial') {
                    const angle = (index - 1) * (2 * Math.PI / (Object.keys(modulesData).length - 1));
                    const radius = 300;
                    const x = Math.cos(angle) * radius;
                    const y = Math.sin(angle) * radius;
                    nodes.add({ ...baseNode, x, y, fixed: { x: false, y: false }, level: module.level });
                } else {
                    nodes.add({ ...baseNode, level: getHierLevelForNode(key) });
                }

                edges.add({
                    from: 'alojaSys',
                    to: key,
                    color: { color: '#ffffff', opacity: 0.6 },
                    width: 2,
                    smooth: { type: 'continuous', roundness: 0.5 }
                });
            });

            // Flujos entre m贸dulos (direccionales)
            const flows = [
                ['empresas','hoteles'],
                ['hoteles','habitaciones'],
                ['hoteles','tarifas'],
                ['hoteles','usuarios'],
                ['habitaciones','reservas'],
                ['tarifas','reservas'],
                ['otas','reservas'],
                ['reservas','calendario'],
                ['reservas','pagos'],
                ['pagos','facturacion'],
                ['pagos','cobros'],
                ['pagos','transferencias'],
                ['pagos','conciliacion'],
                ['reservas','notificaciones']
            ];

            flows.forEach(pair => {
                edges.add({
                    from: pair[0],
                    to: pair[1],
                    color: { color: '#ffffff', opacity: 0.7 },
                    width: 2,
                    arrows: 'to',
                    dashes: true,
                    smooth: { type: 'continuous', roundness: 0.3 }
                });
            });

            // Agregar sub-m贸dulos de pagos
            if (showPaymentSubmodules) Object.keys(paymentSubmodules).forEach((key, index) => {
                const submodule = paymentSubmodules[key];

                const baseNode = {
                    id: key,
                    label: submodule.label,
                    title: submodule.title,
                    shape: 'box',
                    color: getColorForGroup(submodule.group),
                    font: { color: '#ffffff', size: 14, face: 'Arial' },
                    size: 25
                };

                if (layoutMode === 'radial') {
                    const angle = (index) * (2 * Math.PI / Object.keys(paymentSubmodules).length);
                    const radius = 150;
                    const paymentAngle = (Object.keys(modulesData).indexOf('pagos') - 1) * (2 * Math.PI / (Object.keys(modulesData).length - 1));
                    const paymentX = Math.cos(paymentAngle) * 300;
                    const paymentY = Math.sin(paymentAngle) * 300;
                    const x = paymentX + Math.cos(angle) * radius;
                    const y = paymentY + Math.sin(angle) * radius;
                    nodes.add({ ...baseNode, x, y, fixed: { x: false, y: false }, level: submodule.level });
                } else {
                    nodes.add({ ...baseNode, level: getHierLevelForNode(key) });
                }

                edges.add({
                    from: 'pagos',
                    to: key,
                    color: { color: '#ffffff', opacity: 0.4 },
                    width: 1.5,
                    smooth: { type: 'continuous', roundness: 0.3 }
                });
            });
        }

        function getColorForGroup(group) {
            const colors = {
                'center': { background: '#667eea', border: '#764ba2' },
                'config': { background: '#f093fb', border: '#f5576c' },
                'core': { background: '#4facfe', border: '#00f2fe' },
                'payment': { background: '#43e97b', border: '#38f9d7' },
                'policy': { background: '#fa709a', border: '#fee140' },
                'pricing': { background: '#30cfd0', border: '#330867' },
                'analytics': { background: '#a8edea', border: '#fed6e3' },
                'view': { background: '#ff9a9e', border: '#fecfef' },
                'system': { background: '#ffecd2', border: '#fcb69f' },
                'automation': { background: '#ff8a80', border: '#ff5722' },
                'billing': { background: '#84fab0', border: '#8fd3f4' },
                'integration': { background: '#a1c4fd', border: '#c2e9fb' }
            };
            return colors[group] || { background: '#95a5a6', border: '#7f8c8d' };
        }

        function initializeNetwork() {
            createNetworkData();

            const container = document.getElementById('mynetwork');
            const data = {
                nodes: nodes,
                edges: edges
            };

            const options = {
                nodes: {
                    borderWidth: 3,
                    shadow: true,
                    shapeProperties: {
                        borderRadius: 10
                    }
                },
                edges: {
                    shadow: true,
                    arrows: {
                        to: {
                            enabled: false
                        }
                    }
                },
                physics: {
                    enabled: physicsEnabled,
                    stabilization: {
                        enabled: true,
                        iterations: 200
                    },
                    barnesHut: {
                        gravitationalConstant: -2000,
                        centralGravity: 0.1,
                        springLength: 200,
                        springConstant: 0.04,
                        damping: 0.09
                    }
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 100,
                    zoomView: true,
                    dragView: true
                },
                layout: getLayoutOptions()
            };

            network = new vis.Network(container, data, options);

            // Eventos
            network.on('click', function(params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    showNodeInfo(nodeId);
                } else {
                    hideNodeInfo();
                }
            });

            network.on('doubleClick', function(params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    toggleModuleDetails(nodeId);
                }
            });

            network.on('hoverNode', function(params) {
                document.body.style.cursor = 'pointer';
            });

            network.on('blurNode', function(params) {
                document.body.style.cursor = 'default';
            });
        }

        function getHierLevelForNode(nodeId) {
            const map = {
                'alojaSys': 0,
                'empresas': 1,
                'hoteles': 2,
                'usuarios': 2,
                'habitaciones': 3,
                'tarifas': 3,
                'otas': 3,
                'politicasCancelacion': 3,
                'politicasDevolucion': 3,
                'reservas': 4,
                'calendario': 5,
                'pagos': 5,
                'notificaciones': 5,
                'cobros': 6,
                'transferencias': 6,
                'conciliacion': 6,
                'vouchers': 6,
                'facturacion': 6,
                'comprobantes': 6,
                'reembolsos': 6,
                'dashboard': 6
            };
            return map[nodeId] ?? 4;
        }

        function getLayoutOptions() {
            if (layoutMode === 'hierarchical') {
                return {
                    hierarchical: {
                        enabled: true,
                        direction: 'LR',
                        sortMethod: 'hubsize',
                        levelSeparation: 160,
                        nodeSpacing: 110,
                        treeSpacing: 180
                    }
                };
            }
            return { improvedLayout: true };
        }

        function showNodeInfo(nodeId) {
            const infoPanel = document.getElementById('infoPanel');
            const infoTitle = document.getElementById('infoTitle');
            const infoDescription = document.getElementById('infoDescription');
            const infoFeatures = document.getElementById('infoFeatures');
            const infoRequirements = document.getElementById('infoRequirements');
            const infoSteps = document.getElementById('infoSteps');
            const reqTitle = document.getElementById('reqTitle');
            const stepsTitle = document.getElementById('stepsTitle');

            let moduleData = modulesData[nodeId] || paymentSubmodules[nodeId];
            
            if (!moduleData) return;

            infoTitle.textContent = moduleData.title;
            infoDescription.textContent = moduleData.description;
            
            if (moduleData.features) {
                infoFeatures.innerHTML = '';
                moduleData.features.forEach(feature => {
                    const li = document.createElement('li');
                    li.textContent = feature;
                    infoFeatures.appendChild(li);
                });
            } else {
                infoFeatures.innerHTML = '';
            }

            if (moduleData.requirements && moduleData.requirements.length) {
                infoRequirements.innerHTML = '';
                moduleData.requirements.forEach(r => {
                    const li = document.createElement('li');
                    li.textContent = r;
                    infoRequirements.appendChild(li);
                });
                reqTitle.style.display = 'block';
            } else {
                infoRequirements.innerHTML = '';
                reqTitle.style.display = 'none';
            }

            if (moduleData.steps && moduleData.steps.length) {
                infoSteps.innerHTML = '';
                moduleData.steps.forEach(s => {
                    const li = document.createElement('li');
                    li.textContent = s;
                    infoSteps.appendChild(li);
                });
                stepsTitle.style.display = 'block';
            } else {
                infoSteps.innerHTML = '';
                stepsTitle.style.display = 'none';
            }

            infoPanel.style.display = 'block';
        }

        function hideNodeInfo() {
            document.getElementById('infoPanel').style.display = 'none';
        }

        function fitNetwork() {
            if (network) {
                network.fit({
                    animation: {
                        duration: 1000,
                        easingFunction: 'easeInOutQuad'
                    }
                });
            }
        }

        function resetView() {
            if (network) {
                network.setOptions({
                    physics: {
                        enabled: true
                    }
                });
                setTimeout(() => {
                    fitNetwork();
                }, 100);
            }
        }

        function togglePhysics() {
            physicsEnabled = !physicsEnabled;
            if (network) {
                network.setOptions({
                    physics: {
                        enabled: physicsEnabled
                    }
                });
            }
        }

        // Expandir / Colapsar detalles
        function toggleModuleDetails(moduleId) {
            if (!moduleDetails[moduleId]) return;
            if (expandedModules.has(moduleId)) {
                collapseModule(moduleId);
            } else {
                expandModule(moduleId);
            }
        }

        function expandModule(moduleId) {
            const details = moduleDetails[moduleId] || [];
            const parent = nodes.get(moduleId);
            if (!parent) return;
            const radius = 120;
            details.forEach((d, idx) => {
                if (nodes.get(d.id)) return;
                const angle = (idx) * (2 * Math.PI / details.length);
                const x = parent.x + Math.cos(angle) * radius;
                const y = parent.y + Math.sin(angle) * radius;
                nodes.add({
                    id: d.id,
                    label: d.label,
                    shape: 'box',
                    color: getColorForGroup(modulesData[moduleId]?.group || 'config'),
                    font: { color: '#ffffff', size: 12, face: 'Arial' },
                    size: 18,
                    x: x,
                    y: y
                });
                edges.add({
                    from: moduleId,
                    to: d.id,
                    color: { color: '#ffffff', opacity: 0.5 },
                    width: 1.5,
                    arrows: 'to',
                    dashes: true
                });
            });
            expandedModules.add(moduleId);
        }

        function collapseModule(moduleId) {
            const details = moduleDetails[moduleId] || [];
            details.forEach(d => {
                if (nodes.get(d.id)) nodes.remove(d.id);
                const related = edges.get({
                    filter: e => (e.from === moduleId && e.to === d.id) || (e.to === moduleId && e.from === d.id)
                });
                (related || []).forEach(e => edges.remove(e.id));
            });
            expandedModules.delete(moduleId);
        }

        function expandAll() {
            Object.keys(moduleDetails).forEach(k => expandModule(k));
        }

        function collapseAll() {
            Object.keys(moduleDetails).forEach(k => collapseModule(k));
        }

        function setLayout(mode) {
            layoutMode = mode;
            rebuildNetwork();
        }

        function togglePaymentSubs() {
            showPaymentSubmodules = !showPaymentSubmodules;
            rebuildNetwork();
        }

        function rebuildNetwork() {
            const prevExpanded = new Set(expandedModules);
            expandedModules.clear();
            createNetworkData();
            network.setData({ nodes, edges });
            const physicsEnabledNow = layoutMode !== 'hierarchical' && physicsEnabled;
            network.setOptions({ layout: getLayoutOptions(), physics: { enabled: physicsEnabledNow } });
            // Re-expandir nodos que estaban abiertos
            prevExpanded.forEach(id => expandModule(id));
            setTimeout(fitNetwork, 100);
        }

        // Inicializar cuando se carga la p谩gina
        window.addEventListener('load', function() {
            initializeNetwork();
            setTimeout(fitNetwork, 500);
        });
    </script>
</body>
</html>
